bits 64



%define	VGA_AC_INDEX		0x3C0
%define	VGA_AC_WRITE		0x3C0
%define	VGA_AC_READ		0x3C1
%define	VGA_MISC_WRITE		0x3C2
%define VGA_SEQ_INDEX		0x3C4
%define VGA_SEQ_DATA		0x3C5
%define VGA_DAC_STATE               0x3c7
%define VGA_DAC_READ_ADDRESS        0x3c7
%define VGA_DAC_WRITE_ADDRESS       0x3c8
%define VGA_DAC_DATA                0x3c9
%define	VGA_MISC_READ		0x3CC
%define VGA_GC_INDEX 		0x3CE
%define VGA_GC_DATA 		0x3CF
;/*			COLOR emulation		MONO emulation */
%define VGA_CRTC_INDEX		0x3D4		;/* 0x3B4 */
%define VGA_CRTC_DATA		0x3D5		;/* 0x3B5 */
%define	VGA_INSTAT_READ		0x3DA

%define	VGA_NUM_SEQ_REGS	5
%define	VGA_NUM_CRTC_REGS	25
%define	VGA_NUM_GC_REGS		9
%define	VGA_NUM_AC_REGS		21
%define	VGA_NUM_REGS		(1 + VGA_NUM_SEQ_REGS + VGA_NUM_CRTC_REGS + \
				VGA_NUM_GC_REGS + VGA_NUM_AC_REGS)

section .rodata

g_320x200x256:
    ;MISC
    db  0x63
    ;SEQ
    db  0x03, 0x01, 0x0F, 0x00, 0x0E
    ;CRTC
    db  0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F, \
        0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	    0x9C, 0x0E, 0x8F, 0x28,	0x40, 0x96, 0xB9, 0xA3, \
	    0xFF
    ;GC
    db  0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F, \
    	0xFF
    ;AC
    db  0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, \
	    0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, \
	    0x41, 0x00, 0x0F, 0x00,	0x00

g_320x200x256_modex:
    ;/* MISC */
	db  0x63                            
    ;/* SEQ */
	db  0x03, 0x01, 0x0F, 0x00, 0x06
    ;/* CRTC */
	db  0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F, \
	    0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
	    0x9C, 0x0E, 0x8F, 0x28, 0x00, 0x96, 0xB9, 0xE3, \
	    0xFF
    ;/* GC */
	db  0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F, \
	    0xFF
    ;/* AC */
	db  0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, \
	    0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, \
	    0x41, 0x00, 0x0F, 0x00, 0x00

palette_256_colors:
    db  0x00,0x00,0x00, 0x2a,0x00,0x00, 0x00,0x2a,0x00, 0x2a,0x2a,0x00, \
        0x00,0x00,0x2a, 0x2a,0x00,0x2a, 0x00,0x15,0x2a, 0x2a,0x2a,0x2a, \
        0x15,0x15,0x15, 0x3f,0x15,0x15, 0x15,0x3f,0x15, 0x3f,0x3f,0x15, \
        0x15,0x15,0x3f, 0x3f,0x15,0x3f, 0x15,0x3f,0x3f, 0x3f,0x3f,0x3f, \
                                                                        \
        0x00,0x00,0x00, 0x05,0x05,0x05, 0x08,0x08,0x08, 0x0b,0x0b,0x0b, \
        0x0e,0x0e,0x0e, 0x11,0x11,0x11, 0x14,0x14,0x14, 0x18,0x18,0x18, \
        0x1c,0x1c,0x1c, 0x20,0x20,0x20, 0x24,0x24,0x24, 0x28,0x28,0x28, \
        0x2d,0x2d,0x2d, 0x32,0x32,0x32, 0x38,0x38,0x38, 0x3f,0x3f,0x3f, \
                                                                        \
        0x3f,0x00,0x00, 0x3f,0x00,0x10, 0x3f,0x00,0x1f, 0x3f,0x00,0x2f, \
        0x3f,0x00,0x3f, 0x2f,0x00,0x3f, 0x1f,0x00,0x3f, 0x10,0x00,0x3f, \
        0x00,0x00,0x3f, 0x00,0x10,0x3f, 0x00,0x1f,0x3f, 0x00,0x2f,0x3f, \
        0x00,0x3f,0x3f, 0x00,0x3f,0x2f, 0x00,0x3f,0x1f, 0x00,0x3f,0x10, \
                                                                        \
        0x00,0x3f,0x00, 0x10,0x3f,0x00, 0x1f,0x3f,0x00, 0x2f,0x3f,0x00, \
        0x3f,0x3f,0x00, 0x3f,0x2f,0x00, 0x3f,0x1f,0x00, 0x3f,0x10,0x00, \
        0x3f,0x1f,0x1f, 0x3f,0x1f,0x27, 0x3f,0x1f,0x2f, 0x3f,0x1f,0x37, \
        0x3f,0x1f,0x3f, 0x37,0x1f,0x3f, 0x2f,0x1f,0x3f, 0x27,0x1f,0x3f, \
                                                                        \
        0x1f,0x1f,0x3f, 0x1f,0x27,0x3f, 0x1f,0x2f,0x3f, 0x1f,0x37,0x3f, \
        0x1f,0x3f,0x3f, 0x1f,0x3f,0x37, 0x1f,0x3f,0x2f, 0x1f,0x3f,0x27, \
        0x1f,0x3f,0x1f, 0x27,0x3f,0x1f, 0x2f,0x3f,0x1f, 0x37,0x3f,0x1f, \
        0x3f,0x3f,0x1f, 0x3f,0x37,0x1f, 0x3f,0x2f,0x1f, 0x3f,0x27,0x1f, \
                                                                        \
        0x3f,0x2d,0x2d, 0x3f,0x2d,0x31, 0x3f,0x2d,0x36, 0x3f,0x2d,0x3a, \
        0x3f,0x2d,0x3f, 0x3a,0x2d,0x3f, 0x36,0x2d,0x3f, 0x31,0x2d,0x3f, \
        0x2d,0x2d,0x3f, 0x2d,0x31,0x3f, 0x2d,0x36,0x3f, 0x2d,0x3a,0x3f, \
        0x2d,0x3f,0x3f, 0x2d,0x3f,0x3a, 0x2d,0x3f,0x36, 0x2d,0x3f,0x31, \
                                                                        \
        0x2d,0x3f,0x2d, 0x31,0x3f,0x2d, 0x36,0x3f,0x2d, 0x3a,0x3f,0x2d, \
        0x3f,0x3f,0x2d, 0x3f,0x3a,0x2d, 0x3f,0x36,0x2d, 0x3f,0x31,0x2d, \
        0x1c,0x00,0x00, 0x1c,0x00,0x07, 0x1c,0x00,0x0e, 0x1c,0x00,0x15, \
        0x1c,0x00,0x1c, 0x15,0x00,0x1c, 0x0e,0x00,0x1c, 0x07,0x00,0x1c, \
                                                                        \
        0x00,0x00,0x1c, 0x00,0x07,0x1c, 0x00,0x0e,0x1c, 0x00,0x15,0x1c, \
        0x00,0x1c,0x1c, 0x00,0x1c,0x15, 0x00,0x1c,0x0e, 0x00,0x1c,0x07, \
        0x00,0x1c,0x00, 0x07,0x1c,0x00, 0x0e,0x1c,0x00, 0x15,0x1c,0x00, \
        0x1c,0x1c,0x00, 0x1c,0x15,0x00, 0x1c,0x0e,0x00, 0x1c,0x07,0x00, \
                                                                        \
        0x1c,0x0e,0x0e, 0x1c,0x0e,0x11, 0x1c,0x0e,0x15, 0x1c,0x0e,0x18, \
        0x1c,0x0e,0x1c, 0x18,0x0e,0x1c, 0x15,0x0e,0x1c, 0x11,0x0e,0x1c, \
        0x0e,0x0e,0x1c, 0x0e,0x11,0x1c, 0x0e,0x15,0x1c, 0x0e,0x18,0x1c, \
        0x0e,0x1c,0x1c, 0x0e,0x1c,0x18, 0x0e,0x1c,0x15, 0x0e,0x1c,0x11, \
                                                                        \
        0x0e,0x1c,0x0e, 0x11,0x1c,0x0e, 0x15,0x1c,0x0e, 0x18,0x1c,0x0e, \
        0x1c,0x1c,0x0e, 0x1c,0x18,0x0e, 0x1c,0x15,0x0e, 0x1c,0x11,0x0e, \
        0x1c,0x14,0x14, 0x1c,0x14,0x16, 0x1c,0x14,0x18, 0x1c,0x14,0x1a, \
        0x1c,0x14,0x1c, 0x1a,0x14,0x1c, 0x18,0x14,0x1c, 0x16,0x14,0x1c, \
                                                                        \
        0x14,0x14,0x1c, 0x14,0x16,0x1c, 0x14,0x18,0x1c, 0x14,0x1a,0x1c, \
        0x14,0x1c,0x1c, 0x14,0x1c,0x1a, 0x14,0x1c,0x18, 0x14,0x1c,0x16, \
        0x14,0x1c,0x14, 0x16,0x1c,0x14, 0x18,0x1c,0x14, 0x1a,0x1c,0x14, \
        0x1c,0x1c,0x14, 0x1c,0x1a,0x14, 0x1c,0x18,0x14, 0x1c,0x16,0x14, \
                                                                        \
        0x10,0x00,0x00, 0x10,0x00,0x04, 0x10,0x00,0x08, 0x10,0x00,0x0c, \
        0x10,0x00,0x10, 0x0c,0x00,0x10, 0x08,0x00,0x10, 0x04,0x00,0x10, \
        0x00,0x00,0x10, 0x00,0x04,0x10, 0x00,0x08,0x10, 0x00,0x0c,0x10, \
        0x00,0x10,0x10, 0x00,0x10,0x0c, 0x00,0x10,0x08, 0x00,0x10,0x04, \
                                                                        \
        0x00,0x10,0x00, 0x04,0x10,0x00, 0x08,0x10,0x00, 0x0c,0x10,0x00, \
        0x10,0x10,0x00, 0x10,0x0c,0x00, 0x10,0x08,0x00, 0x10,0x04,0x00, \
        0x18,0x08,0x10, 0x10,0x08,0x0a, 0x10,0x08,0x0c, 0x10,0x08,0x0e, \
        0x10,0x08,0x10, 0x0e,0x08,0x10, 0x0c,0x08,0x10, 0x0a,0x08,0x10, \
                                                                        \
        0x08,0x08,0x10, 0x08,0x0a,0x10, 0x08,0x0c,0x10, 0x08,0x0e,0x10, \
        0x08,0x10,0x10, 0x08,0x10,0x0e, 0x08,0x10,0x0c, 0x08,0x10,0x0a, \
        0x08,0x10,0x08, 0x0a,0x10,0x08, 0x0c,0x10,0x08, 0x0e,0x10,0x08, \
        0x10,0x10,0x08, 0x10,0x0e,0x08, 0x10,0x0c,0x08, 0x10,0x0a,0x08, \
                                                                        \
        0x10,0x0b,0x0b, 0x10,0x0b,0x0c, 0x10,0x0b,0x0d, 0x10,0x0b,0x0f, \
        0x10,0x0b,0x10, 0x0f,0x0b,0x10, 0x0d,0x0b,0x10, 0x0c,0x0b,0x10, \
        0x0b,0x0b,0x10, 0x0b,0x0c,0x10, 0x0b,0x0d,0x10, 0x0b,0x0f,0x10, \
        0x0b,0x10,0x10, 0x0b,0x10,0x0f, 0x0b,0x10,0x0d, 0x0b,0x10,0x0c, \
                                                                        \
        0x0b,0x10,0x0b, 0x0c,0x10,0x0b, 0x0d,0x10,0x0b, 0x0f,0x10,0x0b, \
        0x10,0x10,0x0b, 0x10,0x0f,0x0b, 0x10,0x0d,0x0b, 0x10,0x0c,0x0b, \
        0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00, \
        0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x38,0x2b,0x3f  ;adding custom colors on the last 8 indices

%macro __outportb 2
    mov dx, %1
    mov al, %2
    out dx, al
%endmacro

%define outportb(port, data) __outportb port, data

%macro __inportb 1
    mov dx, %1
    in al, dx
%endmacro

%define inportb(port) __inportb port

%include "bootloader/VGA.inc"

section .data

;vga_mode_regs:
;    ;/* MISC */
;	db  0x63                            
;    ;/* SEQ */
;	db  0x03, 0x01, 0x0F, 0x00, 0x06
;    ;/* CRTC */
;	db  0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F, \
;	    0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, \
;	    0x9C, 0x0E, 0x8F, 0x28, 0x00, 0x96, 0xB9, 0xE3, \
;	    0xFF
;    ;/* GC */
;	db  0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F, \
;	    0xFF
;    ;/* AC */
;	db  0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, \
;	    0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, \
;	    0x41, 0x00, 0x0F, 0x00, 0x00

vga_dac_data:
    times 256 * 3 db 0

section .text

;struc vbe_palette_entry:
;u8 blue
;u8 green
;u8 red
;u8 align

;rdi: u8 color
;returns rax: struc vbe_palette_entry rgb
;TODO: fix the order
stdvga_dac_read:
    outportb(VGA_DAC_READ_ADDRESS, dil)
    xor r8, r8
    xor rax, rax
    inportb(VGA_DAC_DATA) ;red
    or r8, rax
    inportb(VGA_DAC_DATA) ;green
    shl rax, 8
    or r8, rax
    xor rax, rax
    inportb(VGA_DAC_DATA) ;blue
    shl rax, 16
    or r8, rax
    mov rax, r8
    ret

;rdi: u8 color
;rsi: struc vbe_palette_entry rgb
stdvga_dac_write:
    outportb(VGA_DAC_WRITE_ADDRESS, dil);
    mov rax, rsi
    outportb(VGA_DAC_DATA, al) ;red
    shr rax, 8
    outportb(VGA_DAC_DATA, al) ;green
    shr rax, 8
    outportb(VGA_DAC_DATA, al) ;blue
    ret

;rdi: struc vbe_palette_entry* addr
;rsi: u8 start
;rdx: int count
stdvga_dac_read_many:
    mov rcx, rdx
    .loop:
        push rdi
        mov rdi, rsi
        call stdvga_dac_read
        pop rdi
        mov [rdi], al ;red
        inc rdi
        shr rax, 8
        mov [rdi], al ;green
        inc rdi
        shr rax, 8
        mov [rdi], al ;blue
        inc rdi
        inc rsi
        loop .loop
    ret

;rdi: struc vbe_palette_entry* addr
;rsi: u8 start
;rdx: count
stdvga_dac_write_many:
    mov rcx, rdx
    .loop:
        mov al, [rdi]
        shl rax, 8
        mov al, [rdi + 1]
        shl rax, 8
        mov al, [rdi + 2]

        push rdi
        push rsi
        mov rdi, rsi
        mov rsi, rax
        call stdvga_dac_write
        pop rsi
        pop rdi

        add rdi, 3
        inc rsi
        loop .loop
    ret

;rdi: unsigned char *regs
read_regs:
	;unsigned i;

    ;/* read MISCELLANEOUS reg */
	inportb(VGA_MISC_READ)
    mov [rdi], al
	inc rdi
    ;/* read SEQUENCER regs */
    mov rcx, VGA_NUM_SEQ_REGS
    mov r8, 0
    .loop1:
		outportb(VGA_SEQ_INDEX, r8b);
        inportb(VGA_SEQ_DATA)
		mov [rdi], al
		inc rdi
        inc r8
        loop .loop1
    ;/* read CRTC regs */
	mov rcx, VGA_NUM_CRTC_REGS
    mov r8, 0
    .loop2:
		outportb(VGA_CRTC_INDEX, r8b)
        inportb(VGA_CRTC_DATA)
		mov [rdi], al
		inc rdi;
        inc r8
        loop .loop2
    ;/* read GRAPHICS CONTROLLER regs */
    mov rcx, VGA_NUM_GC_REGS
    mov r8, 0
	.loop3:
		outportb(VGA_GC_INDEX, r8b)
        inportb(VGA_GC_DATA)
		mov [rdi], al
		inc rdi
        inc r8
        loop .loop3
    ;/* read ATTRIBUTE CONTROLLER regs */
    mov rcx, VGA_NUM_AC_REGS
    mov r8, 0
	.loop4:
		inportb(VGA_INSTAT_READ)
		outportb(VGA_AC_INDEX, r8b)
        inportb(VGA_AC_READ)
		mov [rdi], al
		inc rdi
        inc r8
        loop .loop4
    ;/* lock 16-color palette and unblank display */
	inportb(VGA_INSTAT_READ)
	outportb(VGA_AC_INDEX, 0x20)

;rdi: unsigned char* regs
write_regs:
	;unsigned i;

;/* write MISCELLANEOUS reg */
    outportb(VGA_MISC_WRITE, [rdi])
	inc rdi
;/* write SEQUENCER regs */
    mov rcx, VGA_NUM_SEQ_REGS
    mov r8, 0
.loop1:
    outportb(VGA_SEQ_INDEX, r8b);
	outportb(VGA_SEQ_DATA, [rdi]);
	inc rdi
    inc r8
    loop .loop1
;/* unlock CRTC registers */
    outportb(VGA_CRTC_INDEX, 0x03)
    inportb(VGA_CRTC_DATA)
    or al, 0x80
	outportb(VGA_CRTC_DATA, al)

	outportb(VGA_CRTC_INDEX, 0x11)
    inportb(VGA_CRTC_DATA) 
    and al, ~0x80
	outportb(VGA_CRTC_DATA, al)
;/* make sure they remain unlocked */
    mov al, [rdi + 0x03]
    or al, 0x80
    mov [rdi + 0x03], al

    mov al, [rdi + 0x11]
    and al, ~(0x80)
    mov [rdi + 0x11], al
;/* write CRTC regs */
    mov rcx, VGA_NUM_CRTC_REGS
    mov r8, 0
.loop2:
    outportb(VGA_CRTC_INDEX, r8b)
	outportb(VGA_CRTC_DATA, [rdi])
    inc rdi
    inc r8
    loop .loop2
;/* write GRAPHICS CONTROLLER regs */
    mov rcx, VGA_NUM_GC_REGS
    mov r8, 0
.loop3:
    outportb(VGA_GC_INDEX, r8b);
	outportb(VGA_GC_DATA, [rdi]);
    inc rdi
    inc r8
    loop .loop3
;/* write ATTRIBUTE CONTROLLER regs */
    mov rcx, VGA_NUM_AC_REGS
    mov r8, 0
.loop4:
    inportb(VGA_INSTAT_READ)
    outportb(VGA_AC_INDEX, r8b)
    outportb(VGA_AC_WRITE, [rdi])
    inc rdi
    inc r8
    loop .loop4
;/* lock 16-color palette and unblank display */
    inportb(VGA_INSTAT_READ)
	outportb(VGA_AC_INDEX, 0x20)
    ret

set_graphics_mode:
    mov rdi, g_320x200x256
	call write_regs

    mov rdi, palette_256_colors
    mov rsi, 0
    mov rdx, 256
    call stdvga_dac_write_many
    ret

get_graphics_mode:
    mov rdi, vga_dac_data
    mov rsi, 0
    mov rdx, 256
    call stdvga_dac_read_many
    jmp $